# Asset Tracker – Developer Handbook

> Full-stack offline-first asset-tracking app.  Frontend: **React + Vite + TailwindCSS**.  Backend: **Django 4 + Django REST Framework**.

This README is the single source of truth for any developer who needs to build, run, or deploy the project.

---

## 1. Repository Layout

```
.
├─ django_backend/         # Django project (settings, API app)
│   ├─ api/                # DRF views & auth
│   └─ asset_tracker/      # Django settings / urls / wsgi
├─ src/                    # React + TypeScript source code
├─ public/                 # Static assets copied to build (icons, manifest)
├─ dist/                   # Production build (generated)
├─ .venv/                  # Python virtual-env (local)
├─ package.json            # JS deps & scripts
└─ README.md               # you are here
```

## 2. Prerequisites

| Tool        | Version (tested) | Notes                       |
|-------------|-----------------|-----------------------------|
| Node.js     | ≥ 18            | for Vite dev/build          |
| npm         | ≥ 9             | (or `pnpm` / `yarn`)        |
| Python      | 3.9–3.11        | matches `.venv` interpreter |
| SQLite      | built-in        | default dev database        |

## 3. Quick Start (development)

```bash
# 1) clone & enter repo
python -m venv .venv       # create virtual-env once
source .venv/bin/activate
pip install -r requirements.txt  # backend deps (Django, DRF, bcrypt, etc.)

npm install                # frontend deps

# 2) seed database (creates users, asset_tags, pairs tables)
python django_backend/manage.py migrate   # Django core tables
python scripts/seed_db.py                 # custom tables + default user

# 3) run dev servers (2 terminals)
python django_backend/manage.py runserver 8000  # Backend API
npm run dev                                   # Frontend on :5173
```

Open:
* Frontend http://localhost:5173/
* Backend   http://127.0.0.1:8000/api/health/

### Default credentials
```
username: admin
password: password123
```

## 4. Environment Variables

| File | Key | Description |
|------|-----|-------------|
| `.env` | `VITE_API_BASE` | Override API URL in React build (defaults to `http://localhost:8000/api`) |
|        | `DJANGO_SECRET_KEY` | **Change in production!** |
|        | `JWT_SIGNING_KEY` | Matches `settings.py:SIMPLE_JWT` |

## 5. Database

Development uses SQLite (`django_backend/db.sqlite3`).  Tables are created by:
1. `manage.py migrate` – Django auth & sessions
2. `scripts/seed_db.py` – custom `users`, `asset_tags`, `pairs`

To inspect:
```bash
sqlite3 django_backend/db.sqlite3
.tables
SELECT * FROM users;
```

## 6. Important NPM Scripts

| Script | What it does |
|--------|--------------|
| `npm run dev` | Vite dev-server with HMR (Port 5173) |
| `npm run build` | Creates `dist/` production bundle |
| `npm run preview` | Serves the built bundle locally |

## 7. Deployment (production)

1. Build frontend: `npm run build`  → `dist/`
2. Collect static files (if serving via Django):
   ```bash
   cp -r dist/* django_backend/static/react/
   python django_backend/manage.py collectstatic
   ```
3. Point a WSGI server (gunicorn/Uvicorn) to `asset_tracker.wsgi`.
4. Serve static files via Nginx or Django WhiteNoise.

Alternative: deploy `dist/` to Netlify/Vercel and host Django API separately.

## 8. API Reference

| Method | Endpoint | Purpose |
|--------|----------|---------|
| `POST` | `/api/auth/login/` | User JWT login |
| `GET`  | `/api/asset-tags/` | List asset tags (optional `since` param) |
| `POST` | `/api/pairs/batch/` | Upload array of `{asset_tag, serial}` |
| `GET`  | `/api/pairs/search/` | Lookup pair (`asset_tag` or `serial`) |
| `PUT`  | `/api/pairs/replace/` | Replace serial or asset-tag |

All authenticated requests require:
```
Authorization: Bearer <JWT>
```

## 9. PWA Architecture & Backend Integration

### Front-end (React PWA)

| Feature | Implementation |
|---------|----------------|
| Camera scanning | `BarcodeDetector` (native) → fallback to ZXing WebAssembly |
| Offline cache   | **Dexie/IndexedDB** stores asset tags, scanned pairs, auth token |
| Background sync | Workbox `backgroundSync` queue flushes pairs when online |
| Installability  | `public/manifest.json` + `icons/*`; meta tags in `index.html` |
| Service worker  | Generated by `vite-plugin-pwa`; routes `fetch` to network-first API cache |

### Back-end (Django API)

| Concern | Details |
|---------|---------|
| CORS    | `CORS_ALLOW_ALL_ORIGINS = True` in dev, restrict in prod |
| Auth    | `POST /api/auth/login/` returns **JWT**; React stores in IndexedDB and sends `Authorization: Bearer …` on every request |
| Validation | Raw SQL in `api/views.py` validates credentials & asset tags |
| Token key | `settings.SIMPLE_JWT['SIGNING_KEY']` must match frontend |

### How they talk

1. React reads `VITE_API_BASE` (default `http://localhost:8000/api`).
2. Every `fetch()` goes to Django endpoints.
3. On `401` the front-end clears token and redirects to login.
4. Successful uploads trigger local DB updates so UI stays in sync.



## 10. Troubleshooting Checklist

| Symptom | Likely cause | Fix |
|---------|--------------|-----|
| `500 no such table: users` | DB missing custom tables | Run seed script or restore `db.sqlite3` |
| React dev shows 401 | Wrong credentials / JWT expired | Re-login; check DB hash |
| Icon 192.png 404 | Empty placeholder | Add real PNGs in `public/icons/` |

## 11. Contributing Workflow

1. Create feature branch.
2. Run `npm run lint` & `pytest` (tests TBD).
3. Open PR with concise description & screenshot/GIF.

---
© 2025 Internal project – not for external distribution.


An offline-first Progressive Web App for iOS that allows scanning and tracking asset tag and serial number pairs. Built with React, TypeScript, and optimized for iOS Safari.

## Features

- **Offline-First**: Works completely offline with automatic sync when connection is restored
- **Barcode Scanning**: Uses device camera to scan asset tags and serial numbers (no manual entry allowed)
- **iOS Optimized**: Designed specifically for iOS Safari with PWA capabilities
- **Secure Authentication**: JWT-based authentication with automatic token management
- **Asset Tag Validation**: Validates asset tags against server database
- **Search & Replace**: Find and replace serial numbers for hardware replacements
- **Background Sync**: Automatic upload when connection is restored
- **Touch-Friendly UI**: Large buttons and touch-optimized interface

## Requirements

- iOS 13+ (for full PWA support)
- Safari browser (for installation)
- Camera permission (for barcode scanning)
- HTTPS connection (required for PWA features)

## Installation on iPhone

1. Open Safari and navigate to your app URL
2. Tap the Share button (square with arrow)
3. Scroll down and tap "Add to Home Screen"
4. Tap "Add" to install the app
5. Launch from your home screen for the full app experience

## Development Setup

### Install Dependencies

```bash
npm install
```

### Environment Configuration

```bash
cp .env.example .env
# Edit .env with your API server URL
```

### Development Server

```bash
npm run dev
```

The app will be available at `http://localhost:5173`

### Build for Production

```bash
npm run build
```

## Usage

### Login
- Enter your username and password
- Credentials are stored securely with JWT tokens
- Automatic token refresh and validation

### Scanning Pairs
1. Tap "Scan Asset Tag" and scan the asset tag barcode
2. Tap "Scan Serial Number" and scan the serial number barcode
3. Tap "Add Pair" to store locally
4. Repeat for additional pairs

### Upload Data
- Tap "Upload" to sync pairs with server
- If offline, pairs are queued for automatic upload
- Green status indicates successful upload
- Error messages show validation issues

### Search & Replace
- Use for hardware replacements
- Search by asset tag or serial number
- Replace serial numbers while keeping asset tag
- All changes are logged with timestamp and user

## Technical Details

### Offline Storage
- Uses IndexedDB for local data storage
- Service Worker for offline caching
- Background sync for automatic uploads

### Barcode Scanning
- Primary: BarcodeDetector API (iOS 17+)
- Fallback: ZXing library for older devices
- Supports multiple barcode formats

### PWA Features
- App manifest for installation
- Service worker for offline functionality
- iOS-specific meta tags and optimizations
- Safe area insets for modern iPhones

### Security
- No manual data entry allowed
- JWT authentication with automatic refresh
- HTTPS required for all features
- Asset tag validation against server database

## API Integration

The app expects a REST API with the following endpoints:

- `POST /api/auth/login` - User authentication
- `GET /api/asset-tags` - Fetch asset tag list
- `POST /api/pairs/batch` - Upload scanned pairs
- `GET /api/pairs/search` - Search existing pairs
- `PUT /api/pairs/replace` - Replace serial numbers

## Browser Support

- **iOS Safari**: Full support (recommended)
- **iOS Chrome**: Limited PWA features
- **Android**: Basic functionality (not optimized)

## Deployment

1. Build the app: `npm run build`
2. Deploy `dist/` folder to HTTPS server
3. Ensure proper MIME types for manifest.json
4. Configure server for SPA routing
5. Set up SSL certificate

## Troubleshooting

### Camera Not Working
- Ensure HTTPS connection
- Check camera permissions in Safari settings
- Try refreshing the page

### PWA Not Installing
- Must be accessed via Safari (not Chrome)
- Requires HTTPS connection
- Check manifest.json is accessible

### Offline Sync Issues
- Check network connectivity
- Verify service worker registration
- Clear browser cache if needed

## Development Notes

The lint errors shown during development are expected until dependencies are installed with `npm install`. The app is fully functional once dependencies are resolved.

## License

This project is designed for internal asset tracking use.
## 12. Deep Dive: Django-Powered PWA

This section explains precisely how the **Django 4 + django-pwa** backend turns the React bundle into a fully-installable Progressive Web App (PWA).

### 12.1 Serving the React build through Django
- `npm run build` creates a static bundle inside `dist/`.
- During deployment you can either:
  1. **Copy build into Django static directory**
     ```bash
     cp -r dist/* django_backend/static/react/
     python django_backend/manage.py collectstatic
     ```
     WhiteNoise (enabled automatically in Django ≥4) or your WSGI server will now serve `/static/react/*` files, including `index.html`, `assets`, and compiled JS / CSS.
  2. **Host the React build separately (Netlify/Vercel)** and keep Django as a pure JSON API.  In that case you only need to expose `/api/*` endpoints and enable CORS.

### 12.2 django-pwa configuration
The block in `asset_tracker/settings.py`:
```python
PWA_APP_NAME = 'Asset Tracker'
PWA_APP_DESCRIPTION = 'Offline-first asset tracker'
PWA_APP_THEME_COLOR = '#111827'
PWA_APP_BACKGROUND_COLOR = '#ffffff'
PWA_APP_SCOPE = '/'
PWA_APP_START_URL = '/'
PWA_APP_ICONS = [
    { 'src': '/icons/icon-192.png', 'sizes': '192x192' },
    { 'src': '/icons/icon-512.png', 'sizes': '512x512' }
]
PWA_SERVICE_WORKER_PATH = BASE_DIR / 'static' / 'sw.js'
```
Key points:
- `PWA_SERVICE_WORKER_PATH` tells Django to expose **sw.js** at `/static/sw.js`. The file is generated by `vite-plugin-pwa` during the build.
- django-pwa auto-injects `<link rel="manifest">` and the necessary meta tags into every template that extends `pwa.html` (our `index.html` does).
- Icons live in `public/icons/` and are copied verbatim.

### 12.3 CORS & Auth handshake
- `corsheaders.middleware.CorsMiddleware` + `CORS_ALLOW_ALL_ORIGINS = True` during development lets the React dev-server (port 5173) call Django (port 8001) without pre-flight failures.
- In production set `CORS_ALLOWED_ORIGINS` to the final HTTPS origin of your PWA.
- JWT flow:
  1. React posts credentials to `/api/auth/login/`.
  2. Django signs a JWT with `SIMPLE_JWT['SIGNING_KEY']` and returns it.
  3. All subsequent requests include `Authorization: Bearer <token>`.
  4. When offline the service-worker caches requests and Dexie queues writes for background sync.

### 12.4 Offline & background sync
- **Workbox** routes `/api/*` requests as _network-first_.  If the network is down, they fall back to IndexedDB and queue the mutation.
- When connectivity returns, `workbox-background-sync` replays the queue. Django processes the saved batches exactly as if they were real-time.

### 12.5 Production deployment checklist
1. Build React: `npm run build`.
2. Copy build into Django static dir & run `collectstatic` **or** deploy `dist/` to a CDN.
3. Ensure HTTPS (service-worker & camera scanning both require it).
4. Add the PWA icons and check Lighthouse score ≥ 90.
5. Restrict `CORS_ALLOWED_ORIGINS` and disable `DEBUG`.

### 12.6 Common pitfalls & fixes
| Symptom | Cause | Fix |
|---------|-------|-----|
| **sw.js 404** | `PWA_SERVICE_WORKER_PATH` not copied to static | Re-run build & collectstatic |
| **Manifest icons 404** | `public/icons` missing in `STATICFILES_DIRS` | Add icons or update path |
| **CORS pre-flight fails** | Forgot to set CORS headers in prod | Add domain to `CORS_ALLOWED_ORIGINS` |
| **App installs but shows white screen** | Incorrect `start_url` or scope | Ensure `PWA_APP_START_URL = '/'` and service-worker controls that scope |

---

## License

This project is designed for internal asset tracking use.

